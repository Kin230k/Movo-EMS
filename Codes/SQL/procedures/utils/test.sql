-- ############################################################
-- FULL TEST SCRIPT: SELF-CONTAINED SETUP & TESTS FOR ALL QUESTION TYPES
-- ############################################################
SHOW client_encoding;


-- 0. Clear all tables
DO $$
DECLARE 
    tables TEXT;
BEGIN
    SELECT string_agg(format('%I.%I', schemaname, tablename), ', ')
    INTO tables
    FROM pg_tables
    WHERE schemaname NOT IN ('pg_catalog', 'information_schema');
    
    IF tables IS NOT NULL THEN
        EXECUTE 'TRUNCATE ' || tables || ' RESTART IDENTITY CASCADE';
    END IF;
END $$;

-- 1. Create minimal parent hierarchy

-- 1.1 CLIENT
-- ############################################################
-- FULL TEST SCRIPT: SELF-CONTAINED SETUP & TESTS FOR ALL QUESTION TYPES
-- ############################################################
S-- ############################################################
-- FULL TEST SCRIPT: SELF-CONTAINED SETUP & TESTS FOR ALL QUESTION TYPES
-- ############################################################
SHOW client_encoding;

-- 0. Clear all tables
DO $$
DECLARE 
    tables TEXT;
BEGIN
    SELECT string_agg(format('%I.%I', schemaname, tablename), ', ')
    INTO tables
    FROM pg_tables
    WHERE schemaname NOT IN ('pg_catalog', 'information_schema');
    
    IF tables IS NOT NULL THEN
        EXECUTE 'TRUNCATE ' || tables || ' RESTART IDENTITY CASCADE';
    END IF;
END $$;

-- 1. Create minimal parent hierarchy

-- 1.1 CLIENT
INSERT INTO CLIENTS (clientId, name, company, contactEmail, contactPhone)
VALUES (
  '11111111-1111-1111-1111-111111111110',
  '{"en": "Test Client", "ar": "عميل"}'::jsonb,
  '{"en": "Test Co", "ar": "شركة"}'::jsonb,
  'client@test0.com',
  '0100000001'
);

-- 1.2 PROJECT
INSERT INTO PROJECTS (projectId, clientId, name,endingdate)
VALUES (
  '22222222-2222-2222-2222-222222222202',
  '11111111-1111-1111-1111-111111111110',
  '{"en":"Test Project","ar":"المشروع"}',
  '2025-10-10'
);

-- 1.3 LOCATION
INSERT INTO LOCATIONS (locationId, name, projectId)
VALUES (
  '44444444-4444-4444-4444-444444444440',
  '{"en":"Site","ar":"الموقع"}',
  '22222222-2222-2222-2222-222222222202'
);

-- 1.4 FORM
INSERT INTO FORMS (formId, locationId)
VALUES (
  '55555555-5555-5555-5555-555555555550',
  '44444444-4444-4444-4444-444444444440'
);

-- 1.5 INTERVIEW
INSERT INTO INTERVIEWS (interviewId, projectId)
VALUES (
  '66666666-6666-6666-6666-666666666660',
  '22222222-2222-2222-2222-222222222202'
);

-- 1.6 USER
INSERT INTO USERS (userId, name, email, phone, role)
VALUES (
  '77777777-7777-7777-7777-777777777770',
  '{"en":"Tester","ar":"مختبر"}',
  'user@test.com',
  '0550000000',
  'Supervisor'
);

-- 1.7 SUBMISSION
INSERT INTO SUBMISSIONS (submissionId, formId, userId, interviewId)
VALUES (
  '88888888-8888-8888-8888-888888888880',
  '55555555-5555-5555-5555-555555555550',
  '77777777-7777-7777-7777-777777777770',
  '66666666-6666-6666-6666-666666666660'
);



-- 3. TEST EACH QUESTION TYPE

-- 3.1 OPEN_ENDED: should PASS on "good"
INSERT INTO QUESTIONS(questionId,typeCode,questionText,formId,interviewId)
VALUES ('10000001-0001-4000-8000-000000000001','OPEN_ENDED',
  '{"en":"Say something good","ar":"قل شيئاً جيداً"}',
  '55555555-5555-5555-5555-555555555550',
  '66666666-6666-6666-6666-666666666660'
);
INSERT INTO CRITERIA(criterionId,questionId,type,value,effect) VALUES
  ('20000001-0001-4000-8000-000000000001','10000001-0001-4000-8000-000000000001','contains','good','PASS'),
  ('20000001-0001-4000-8000-000000000002','10000001-0001-4000-8000-000000000001','contains','bad','FAIL');
INSERT INTO ANSWERS(answerId,submissionId,questionId)
VALUES ('30000001-0001-4000-8000-000000000001','88888888-8888-8888-8888-888888888880','10000001-0001-4000-8000-000000000001');
INSERT INTO TEXT_ANSWERS(answerId,response)
VALUES ('30000001-0001-4000-8000-000000000001','It was a good test.');
SELECT * FROM CRITERIA_RESULTS WHERE answerId='30000001-0001-4000-8000-000000000001';
SELECT * FROM ANSWER_RESULTS   WHERE answerId='30000001-0001-4000-8000-000000000001';

-- 3.1b OPEN_ENDED: should be MANUAL
INSERT INTO ANSWERS(answerId,submissionId,questionId)
VALUES (
  '30000001-0001-4000-8000-000000000009',
  '88888888-8888-8888-8888-888888888880',
  '10000001-0001-4000-8000-000000000001'
);
INSERT INTO TEXT_ANSWERS(answerId,response)
VALUES (
  '30000001-0001-4000-8000-000000000009',
  'just okay'
);
SELECT * FROM CRITERIA_RESULTS WHERE answerId='30000001-0001-4000-8000-000000000009';
SELECT * FROM ANSWER_RESULTS   WHERE answerId='30000001-0001-4000-8000-000000000009';

-- 3.2 SHORT_ANSWER: should PASS on "yes"
INSERT INTO QUESTIONS(questionId,typeCode,questionText,formId,interviewId)
VALUES ('10000001-0002-4000-8000-000000000002','SHORT_ANSWER',
  '{"en":"Shortly describe","ar":"وصف باختصار"}',
  '55555555-5555-5555-5555-555555555550',
  '66666666-6666-6666-6666-666666666660'
);
INSERT INTO CRITERIA(criterionId,questionId,type,value,effect) VALUES
  ('20000001-0002-4000-8000-000000000003','10000001-0002-4000-8000-000000000002','contains','yes','PASS'),
  ('20000001-0002-4000-8000-000000000004','10000001-0002-4000-8000-000000000002','contains','no','FAIL');
INSERT INTO ANSWERS(answerId,submissionId,questionId)
VALUES ('30000001-0002-4000-8000-000000000002','88888888-8888-8888-8888-888888888880','10000001-0002-4000-8000-000000000002');
INSERT INTO TEXT_ANSWERS(answerId,response)
VALUES ('30000001-0002-4000-8000-000000000002','yes definitely');
SELECT * FROM CRITERIA_RESULTS WHERE answerId='30000001-0002-4000-8000-000000000002';
SELECT * FROM ANSWER_RESULTS   WHERE answerId='30000001-0002-4000-8000-000000000002';

-- 3.3 NUMBER: should PASS on 7 (in range [5,10])
INSERT INTO QUESTIONS(questionId,typeCode,questionText,formId,interviewId)
VALUES ('10000001-0003-4000-8000-000000000003','NUMBER',
  '{"en":"How many?","ar":"كم؟"}',
  '55555555-5555-5555-5555-555555555550',
  '66666666-6666-6666-6666-666666666660'
);
INSERT INTO CRITERIA(criterionId,questionId,type,value,effect) VALUES
  ('20000001-0003-4000-8000-000000000005','10000001-0003-4000-8000-000000000003','range','[5,10]','PASS'),
  ('20000001-0003-4000-8000-000000000006','10000001-0003-4000-8000-000000000003','range','[0,5)','FAIL'),
  ('20000001-0003-4000-8000-000000000007','10000001-0003-4000-8000-000000000003','range','(10,100]','MANUAL');
INSERT INTO ANSWERS(answerId,submissionId,questionId)
VALUES ('30000001-0003-4000-8000-000000000003','88888888-8888-8888-8888-888888888880','10000001-0003-4000-8000-000000000003');
INSERT INTO NUMERIC_ANSWERS(answerId,response)
VALUES ('30000001-0003-4000-8000-000000000003',7);
SELECT * FROM CRITERIA_RESULTS WHERE answerId='30000001-0003-4000-8000-000000000003';
SELECT * FROM ANSWER_RESULTS   WHERE answerId='30000001-0003-4000-8000-000000000003';

-- 3.4 RATE: should PASS on 4 (>=4)
INSERT INTO QUESTIONS(questionId,typeCode,questionText,formId,interviewId)
VALUES ('10000001-0004-4000-8000-000000000004','RATE',
  '{"en":"Rate from 1 to 5","ar":"قيم من 1 إلى 5"}',
  '55555555-5555-5555-5555-555555555550',
  '66666666-6666-6666-6666-666666666660'
);
INSERT INTO CRITERIA(criterionId,questionId,type,value,effect) VALUES
  ('20000001-0004-4000-8000-000000000008','10000001-0004-4000-8000-000000000004','value','4','PASS'),
  ('20000001-0004-4000-8000-000000000009','10000001-0004-4000-8000-000000000004','value','3','MANUAL'),
  ('20000001-0004-4000-8000-000000000010','10000001-0004-4000-8000-000000000004','value','2','FAIL');
INSERT INTO ANSWERS(answerId,submissionId,questionId)
VALUES ('30000001-0004-4000-8000-000000000004','88888888-8888-8888-8888-888888888880','10000001-0004-4000-8000-000000000004');
INSERT INTO RATE_ANSWERS(answerId,response)
VALUES ('30000001-0004-4000-8000-000000000004',4);
SELECT * FROM CRITERIA_RESULTS WHERE answerId='30000001-0004-4000-8000-000000000004';
SELECT * FROM ANSWER_RESULTS   WHERE answerId='30000001-0004-4000-8000-000000000004';

-- 3.5 DROPDOWN: should PASS on 'option1'
INSERT INTO QUESTIONS(questionId,typeCode,questionText,formId,interviewId)
VALUES ('10000001-0005-4000-8000-000000000005','DROPDOWN',
  '{"en":"Choose one","ar":"اختر واحد"}',
  '55555555-5555-5555-5555-555555555550',
  '66666666-6666-6666-6666-666666666660'
);
INSERT INTO OPTIONS(optionId,questionId,label) VALUES
  ('40000001-0005-4000-8000-000000000001','10000001-0005-4000-8000-000000000005','option1'),
  ('40000001-0005-4000-8000-000000000002','10000001-0005-4000-8000-000000000005','option2'),
  ('40000001-0005-4000-8000-000000000003','10000001-0005-4000-8000-000000000005','option3');
INSERT INTO CRITERIA(criterionId,questionId,type,value,effect) VALUES
  ('20000001-0005-4000-8000-000000000011','10000001-0005-4000-8000-000000000005','value','option1','PASS'),
  ('20000001-0005-4000-8000-000000000012','10000001-0005-4000-8000-000000000005','value','option2','FAIL'),
  ('20000001-0005-4000-8000-000000000013','10000001-0005-4000-8000-000000000005','value','option3','MANUAL');
INSERT INTO ANSWERS(answerId,submissionId,questionId)
VALUES ('30000001-0005-4000-8000-000000000005','88888888-8888-8888-8888-888888888880','10000001-0005-4000-8000-000000000005');
INSERT INTO DROPDOWN_ANSWERS(answerId,response)
VALUES ('30000001-0005-4000-8000-000000000005','option1');
SELECT * FROM CRITERIA_RESULTS WHERE answerId='30000001-0005-4000-8000-000000000005';
SELECT * FROM ANSWER_RESULTS   WHERE answerId='30000001-0005-4000-8000-000000000005';

-- 3.6 RADIO: should PASS on 'choice1'
INSERT INTO QUESTIONS(questionId,typeCode,questionText,formId,interviewId)
VALUES ('10000001-0006-4000-8000-000000000006','RADIO',
  '{"en":"Select one","ar":"اختر واحد"}',
  '55555555-5555-5555-5555-555555555550',
  '66666666-6666-6666-6666-666666666660'
);
INSERT INTO OPTIONS(optionId,questionId,label) VALUES
  ('40000001-0006-4000-8000-000000000004','10000001-0006-4000-8000-000000000006','choice1'),
  ('40000001-0006-4000-8000-000000000005','10000001-0006-4000-8000-000000000006','choice2'),
  ('40000001-0006-4000-8000-000000000006','10000001-0006-4000-8000-000000000006','choice3');
INSERT INTO CRITERIA(criterionId,questionId,type,value,effect) VALUES
  ('20000001-0006-4000-8000-000000000014','10000001-0006-4000-8000-000000000006','value','choice1','PASS'),
  ('20000001-0006-4000-8000-000000000015','10000001-0006-4000-8000-000000000006','value','choice2','FAIL'),
  ('20000001-0006-4000-8000-000000000016','10000001-0006-4000-8000-000000000006','value','choice3','MANUAL');
INSERT INTO ANSWERS(answerId,submissionId,questionId)
VALUES ('30000001-0006-4000-8000-000000000006','88888888-8888-8888-8888-888888888880','10000001-0006-4000-8000-000000000006');
INSERT INTO RADIO_ANSWERS(answerId,response)
VALUES ('30000001-0006-4000-8000-000000000006','choice1');
SELECT * FROM CRITERIA_RESULTS WHERE answerId='30000001-0006-4000-8000-000000000006';
SELECT * FROM ANSWER_RESULTS   WHERE answerId='30000001-0006-4000-8000-000000000006';

-- 3.7 MULTIPLE_CHOICE: should PASS on ['A','C'] (contains A)
INSERT INTO QUESTIONS(questionId,typeCode,questionText,formId,interviewId)
VALUES ('10000001-0007-4000-8000-000000000007','MULTIPLE_CHOICE',
  '{"en":"Select all that apply","ar":"اختر كل ما ينطبق"}',
  '55555555-5555-5555-5555-555555555550',
  '66666666-6666-6666-6666-666666666660'
);
INSERT INTO OPTIONS(optionId,questionId,label) VALUES
  ('40000001-0007-4000-8000-000000000007','10000001-0007-4000-8000-000000000007','A'),
  ('40000001-0007-4000-8000-000000000008','10000001-0007-4000-8000-000000000007','B'),
  ('40000001-0007-4000-8000-000000000009','10000001-0007-4000-8000-000000000007','C');
INSERT INTO CRITERIA(criterionId,questionId,type,value,effect) VALUES
  ('20000001-0007-4000-8000-000000000017','10000001-0007-4000-8000-000000000007','contains','A','PASS'),
  ('20000001-0007-4000-8000-000000000018','10000001-0007-4000-8000-000000000007','contains','B','FAIL'),
  ('20000001-0007-4000-8000-000000000019','10000001-0007-4000-8000-000000000007','contains','C','MANUAL');
INSERT INTO ANSWERS(answerId,submissionId,questionId)
VALUES ('30000001-0007-4000-8000-000000000007','88888888-8888-8888-8888-888888888880','10000001-0007-4000-8000-000000000007');
INSERT INTO MULTIPLE_CHOICE_ANSWERS(answerId,response)
VALUES ('30000001-0007-4000-8000-000000000007','["A","C"]');
SELECT * FROM CRITERIA_RESULTS WHERE answerId='30000001-0007-4000-8000-000000000007';
SELECT * FROM ANSWER_RESULTS   WHERE answerId='30000001-0007-4000-8000-000000000007';