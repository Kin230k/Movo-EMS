<div class="page">
  <div class="toolbar">
    <form [formGroup]="form" class="toolbar-form">
      <app-combo-selector
        [projects]="projects"
        (projectSelected)="onProjectSelect($event)"
        placeholder="{{ 'CREATE_FORM_QUESTIONS.PROJECT_NAME' | translate }}"
      ></app-combo-selector>
      <app-combo-selector
        [projects]="forms"
        (projectSelected)="onFormSelect($event)"
        placeholder="{{ 'CREATE_FORM_QUESTIONS.FORM_NAME' | translate }}"
      ></app-combo-selector>
      <app-combo-selector
        [projects]="languages"
        (projectSelected)="onLanguageSelect($event)"
        placeholder="{{ 'CREATE_FORM_QUESTIONS.LANGUAGE' | translate }}"
      ></app-combo-selector>

      <button class="btn btn--purple" (click)="addQuestion()">
        {{ "CREATE_FORM_QUESTIONS.ADD_QUESTION" | translate }}
      </button>
    </form>
  </div>

  <form class="question-list" [formGroup]="form" (ngSubmit)="saveAll()">
    <div *ngIf="questions.length === 0" class="empty-state">
      <p>{{ "CREATE_FORM_QUESTIONS.NO_QUESTIONS" | translate }}</p>
    </div>

    <!-- bind each question FormGroup directly to the card via [formGroup] -->
    <div
      class="question-card"
      *ngFor="let q of questions.controls; let i = index; trackBy: trackById"
      [formGroup]="q"
    >
      <button class="trash" (click)="removeQuestion(i)" aria-label="delete">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
          class="lucide lucide-x"
        >
          <path d="M18 6 6 18" />
          <path d="m6 6 12 12" />
        </svg>
      </button>
      <div class="question-card__controls">
        <app-combo-selector
          [projects]="questionTypes"
          (projectSelected)="onQuestionTypeSelect($event, i)"
          placeholder="{{ 'CREATE_FORM_QUESTIONS.QUESTION_TYPE' | translate }}"
        ></app-combo-selector>
      </div>
      <div class="question-card__main">
        <input
          class="input input--single"
          formControlName="text"
          placeholder="{{ 'CREATE_FORM_QUESTIONS.QUESTION_TEXT' | translate }}"
        />

        <!-- Conditional input based on question type -->
        <div
          class="question-input"
          *ngIf="q.get('type')?.value; else noTypeSelected"
        >
          <!-- Short Answer -->
          <!-- <div
            *ngIf="q.get('type')?.value === 'SHORT_ANSWER'"
            class="input-section"
          >
            <label>{{
              "CREATE_FORM_QUESTIONS.SHORT_ANSWER_INPUT" | translate
            }}</label>
            <input
              type="text"
              class="input input--single"
              formControlName="description"
              placeholder="{{
                'CREATE_FORM_QUESTIONS.ENTER_SHORT_ANSWER' | translate
              }}"
            />
          </div> -->

          <!-- Long Answer -->
          <!-- <div
            *ngIf="q.get('type')?.value === 'OPEN_ENDED'"
            class="input-section"
          >
            <label>{{
              "CREATE_FORM_QUESTIONS.LONG_ANSWER_INPUT" | translate
            }}</label>
            <textarea
              class="input input--textarea"
              formControlName="description"
              placeholder="{{
                'CREATE_FORM_QUESTIONS.ENTER_LONG_ANSWER' | translate
              }}"
            ></textarea>
          </div> -->

          <!-- Rating -->
          <!-- <div *ngIf="q.get('type')?.value === 'NUMBER'" class="input-section">
            <label>{{
              "CREATE_FORM_QUESTIONS.RATING_INPUT" | translate
            }}</label>
            <input
              type="number"
              class="input input--single"
              formControlName="description"
              placeholder="{{
                'CREATE_FORM_QUESTIONS.ENTER_RATING' | translate
              }}"
              min="1"
              max="10"
            />
          </div> -->

          <!-- Multiple Choice -->
          <div
            *ngIf="q.get('type')?.value === 'MULTIPLE_CHOICE'"
            class="input-section choice-section"
          >
            <label>{{
              "CREATE_FORM_QUESTIONS.MULTIPLE_CHOICE_OPTIONS" | translate
            }}</label>
            <div class="options">
              <div
                *ngFor="let opt of getOptionsControls(i); let oi = index"
                [formGroup]="opt"
                class="option-item"
              >
                <input
                  type="checkbox"
                  formControlName="isCorrect"
                  (change)="onOptionChange(i, oi, $event)"
                  class="input input--single-small"
                />
                <input
                  formControlName="optionText"
                  placeholder="{{
                    'CREATE_FORM_QUESTIONS.OPTION_LABEL' | translate
                  }}"
                  class="input input--single"
                />
                <button
                  type="button"
                  class="btn btn--secondary"
                  (click)="removeOption(i, oi)"
                >
                  {{ "CREATE_FORM_QUESTIONS.DELETE" | translate }}
                </button>
              </div>
              <button
                type="button"
                class="btn btn--small"
                (click)="addOption(i)"
              >
                {{ "CREATE_FORM_QUESTIONS.ADD_OPTION" | translate }}
              </button>
            </div>
          </div>

          <!-- Radio -->
          <div
            *ngIf="q.get('type')?.value === 'RADIO'"
            class="input-section choice-section"
          >
            <label>{{
              "CREATE_FORM_QUESTIONS.RADIO_OPTIONS" | translate
            }}</label>
            <div class="options">
              <div
                *ngFor="let opt of getOptionsControls(i); let oi = index"
                [formGroup]="opt"
                class="option-item"
              >
                <input
                  type="radio"
                  formControlName="isCorrect"
                  (change)="onOptionChange(i, oi, $event)"
                  [checked]="opt.get('isCorrect')?.value"
                  class="input input--single-small"
                />
                <input
                  formControlName="optionText"
                  placeholder="{{
                    'CREATE_FORM_QUESTIONS.OPTION_LABEL' | translate
                  }}"
                  class="input input--single"
                />
                <button
                  type="button"
                  class="btn btn--secondary"
                  (click)="removeOption(i, oi)"
                >
                  {{ "CREATE_FORM_QUESTIONS.DELETE" | translate }}
                </button>
              </div>
              <button
                type="button"
                class="btn btn--small"
                (click)="addOption(i)"
              >
                {{ "CREATE_FORM_QUESTIONS.ADD_OPTION" | translate }}
              </button>
            </div>
          </div>
        </div>

        <!-- No type selected message -->
        <ng-template #noTypeSelected>
          <div class="no-type-message">
            <p>
              {{ "CREATE_FORM_QUESTIONS.SELECT_TYPE_FIRST" | translate }}
            </p>
          </div>
        </ng-template>

        <!-- Pass the whole question FormGroup to the child so it can bind directly -->
        <app-question-criteria
          *ngIf="shouldShowCriteriaSection(q.get('type')?.value)"
          [question]="q"
          [questionIndex]="i"
          [conditionOptions]="getFilteredConditionOptions(q.get('type')?.value)"
          [addCriteria]="addCriteria.bind(this)"
          [removeCriteria]="removeCriteria.bind(this)"
        >
        </app-question-criteria>

        <!-- options area for multiple-choice type -->
      </div>
    </div>
  </form>
  <div class="actions" *ngIf="questions.length > 0">
    <button type="button" class="btn btn--purple" (click)="saveAll()">
      {{ "CREATE_FORM_QUESTIONS.SAVE_ALL_QUESTIONS" | translate }}
    </button>
  </div>
</div>
