<div class="modal-backdrop" *ngIf="visible">
  <!-- Loading overlay for form submission -->
  <div class="overlay" *ngIf="isSubmitting()">
    <div class="spinner" role="status" aria-hidden="true"></div>
    <div class="overlay-msg">
      {{ "CREATE_FORM_QUESTIONS.MODAL.UPDATING_QUESTION" | translate }}
    </div>
  </div>

  <div class="modal">
    <header class="modal-header">
      <h3>
        {{ "CREATE_FORM_QUESTIONS.MODAL.EDIT_QUESTION_TITLE" | translate }}
      </h3>
      <button
        class="close-btn"
        [attr.aria-label]="'COMMON.BUTTONS.CANCEL' | translate"
        (click)="onClose()"
      >
        âœ•
      </button>
    </header>
    <section class="modal-body" [formGroup]="form">
      <label class="label">{{
        "CREATE_FORM_QUESTIONS.MODAL.TEXT_LABEL" | translate
      }}</label>
      <input
        class="text-input"
        formControlName="questionText"
        [class.error-border]="
          form.get('questionText')?.invalid &&
          (form.get('questionText')?.touched || form.get('questionText')?.dirty)
        "
      />
      <div
        class="field-error"
        *ngIf="
          form.get('questionText')?.invalid &&
          (form.get('questionText')?.touched || form.get('questionText')?.dirty)
        "
      >
        <small class="error-text">{{
          "COMMON.ERRORS.REQUIRED" | translate
        }}</small>
      </div>

      <label class="label">{{
        "CREATE_FORM_QUESTIONS.MODAL.DESCRIPTION_LABEL" | translate
      }}</label>
      <input class="text-input" formControlName="description" />

      <label class="label">{{
        "CREATE_FORM_QUESTIONS.MODAL.TYPE_LABEL" | translate
      }}</label>
      <app-combo-selector
        [projects]="questionTypes"
        [selectedValue]="form.get('typeCode')?.value"
        [hasError]="
          !!(
            form.get('typeCode')?.invalid &&
            (form.get('typeCode')?.touched || form.get('typeCode')?.dirty)
          )
        "
        (projectSelected)="onQuestionTypeSelect($event)"
        placeholder="{{ 'CREATE_FORM_QUESTIONS.MODAL.TYPE_LABEL' | translate }}"
      ></app-combo-selector>
      <div
        class="field-error"
        *ngIf="
          form.get('typeCode')?.invalid &&
          (form.get('typeCode')?.touched || form.get('typeCode')?.dirty)
        "
      >
        <small class="error-text">{{
          "CREATE_FORM_QUESTIONS.SELECT_TYPE_FIRST" | translate
        }}</small>
      </div>

      <!-- Multiple Choice Options -->
      <div *ngIf="form.get('typeCode')?.value === 'MULTIPLE_CHOICE'">
        <label class="label">{{
          "CREATE_FORM_QUESTIONS.MULTIPLE_CHOICE_OPTIONS" | translate
        }}</label>
        <div class="options-list">
          <div
            class="option-row"
            *ngFor="let opt of optionsControls.controls; let i = index"
            [formGroup]="opt"
          >
            <input
              class="text-input"
              formControlName="optionText"
              [placeholder]="
                'CREATE_FORM_QUESTIONS.MODAL.OPTION_PLACEHOLDER' | translate
              "
            />
            <input
              class="checkbox"
              type="checkbox"
              formControlName="isCorrect"
            />
            <button
              type="button"
              class="secondary-btn"
              (click)="removeOption(i)"
            >
              {{ "CREATE_FORM_QUESTIONS.MODAL.REMOVE_OPTION" | translate }}
            </button>
          </div>
          <div class="actions">
            <button type="button" class="primary-btn" (click)="addOption()">
              {{ "CREATE_FORM_QUESTIONS.MODAL.ADD_OPTION" | translate }}
            </button>
          </div>
        </div>
      </div>

      <!-- Radio Options -->
      <div *ngIf="form.get('typeCode')?.value === 'RADIO'">
        <label class="label">{{
          "CREATE_FORM_QUESTIONS.RADIO_OPTIONS" | translate
        }}</label>
        <div class="options-list">
          <div
            class="option-row"
            *ngFor="let opt of optionsControls.controls; let i = index"
            [formGroup]="opt"
          >
            <input
              class="text-input"
              formControlName="optionText"
              [placeholder]="
                'CREATE_FORM_QUESTIONS.MODAL.OPTION_PLACEHOLDER' | translate
              "
            />
            <input
              class="radio"
              type="radio"
              name="radio-option-edit"
              [value]="i"
              [checked]="opt.get('isCorrect')?.value"
              (change)="onRadioChange(i)"
            />
            <button
              type="button"
              class="secondary-btn"
              (click)="removeOption(i)"
            >
              {{ "CREATE_FORM_QUESTIONS.MODAL.REMOVE_OPTION" | translate }}
            </button>
          </div>
          <div class="actions">
            <button type="button" class="primary-btn" (click)="addOption()">
              {{ "CREATE_FORM_QUESTIONS.MODAL.ADD_OPTION" | translate }}
            </button>
          </div>
        </div>
      </div>

      <!-- Criteria sections for text/number types -->
      <div
        *ngIf="
          !['RADIO', 'MULTIPLE_CHOICE'].includes(form.get('typeCode')?.value)
        "
      >
        <div class="criteria-section">
          <h5 class="label">
            {{
              "CREATE_FORM_QUESTIONS.MODAL.FAILED_CRITERIA_TITLE" | translate
            }}
          </h5>
          <div
            class="criteria-row"
            *ngFor="let c of getFailCriteria(); let ci = index"
            [formGroup]="c"
          >
            <app-combo-selector
              [projects]="
                getFilteredConditionOptions(form.get('typeCode')?.value)
              "
              [selectedValue]="c.get('type')?.value"
              [hasError]="
                !!(
                  c.get('type')?.invalid &&
                  (c.get('type')?.touched || c.get('type')?.dirty)
                )
              "
              (projectSelected)="onConditionSelect($event, c)"
              placeholder="{{
                'CREATE_FORM_QUESTIONS.MODAL.CONDITION_PLACEHOLDER' | translate
              }}"
            ></app-combo-selector>
            <div
              class="field-error"
              *ngIf="
                c.get('type')?.invalid &&
                (c.get('type')?.touched || c.get('type')?.dirty)
              "
            >
              <small class="error-text">{{
                "COMMON.ERRORS.REQUIRED" | translate
              }}</small>
            </div>
            <input
              class="text-input"
              formControlName="value"
              [placeholder]="
                'CREATE_FORM_QUESTIONS.MODAL.VALUE_PLACEHOLDER' | translate
              "
            />
            <input
              *ngIf="c.get('type')?.value === 'between'"
              class="text-input"
              formControlName="valueTo"
              [placeholder]="
                'CREATE_FORM_QUESTIONS.MODAL.VALUE_TO_PLACEHOLDER' | translate
              "
            />
            <button
              type="button"
              class="secondary-btn"
              (click)="removeCriteria(c)"
            >
              {{ "CREATE_FORM_QUESTIONS.MODAL.DELETE" | translate }}
            </button>
          </div>
          <div class="actions">
            <button
              type="button"
              class="primary-btn"
              (click)="addCriteria('FAIL')"
            >
              {{ "CREATE_FORM_QUESTIONS.MODAL.ADD_FAILED" | translate }}
            </button>
          </div>
        </div>

        <div class="criteria-section">
          <h5 class="label">
            {{ "CREATE_FORM_QUESTIONS.MODAL.PASS_CRITERIA_TITLE" | translate }}
          </h5>
          <div
            class="criteria-row"
            *ngFor="let c of getPassCriteria(); let ci = index"
            [formGroup]="c"
          >
            <app-combo-selector
              [projects]="
                getFilteredConditionOptions(form.get('typeCode')?.value)
              "
              [selectedValue]="c.get('type')?.value"
              [hasError]="
                !!(
                  c.get('type')?.invalid &&
                  (c.get('type')?.touched || c.get('type')?.dirty)
                )
              "
              (projectSelected)="onConditionSelect($event, c)"
              placeholder="{{
                'CREATE_FORM_QUESTIONS.MODAL.CONDITION_PLACEHOLDER' | translate
              }}"
            ></app-combo-selector>
            <div
              class="field-error"
              *ngIf="
                c.get('type')?.invalid &&
                (c.get('type')?.touched || c.get('type')?.dirty)
              "
            >
              <small class="error-text">{{
                "COMMON.ERRORS.REQUIRED" | translate
              }}</small>
            </div>
            <input
              class="text-input"
              formControlName="value"
              [placeholder]="
                'CREATE_FORM_QUESTIONS.MODAL.VALUE_PLACEHOLDER' | translate
              "
            />
            <input
              *ngIf="c.get('type')?.value === 'between'"
              class="text-input"
              formControlName="valueTo"
              [placeholder]="
                'CREATE_FORM_QUESTIONS.MODAL.VALUE_TO_PLACEHOLDER' | translate
              "
            />
            <button
              type="button"
              class="secondary-btn"
              (click)="removeCriteria(c)"
            >
              {{ "CREATE_FORM_QUESTIONS.MODAL.DELETE" | translate }}
            </button>
          </div>
          <div class="actions">
            <button
              type="button"
              class="primary-btn"
              (click)="addCriteria('PASS')"
            >
              {{ "CREATE_FORM_QUESTIONS.MODAL.ADD_PASS" | translate }}
            </button>
          </div>
        </div>
      </div>
    </section>
    <footer class="modal-footer">
      <button type="button" class="secondary-btn" (click)="onClose()">
        {{ "CREATE_FORM_QUESTIONS.MODAL.CANCEL" | translate }}
      </button>
      <button type="button" class="primary-btn" (click)="onSave()">
        {{ "CREATE_FORM_QUESTIONS.MODAL.SAVE" | translate }}
      </button>
    </footer>
  </div>
</div>
